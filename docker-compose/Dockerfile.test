# Multi-stage Dockerfile for the 3-stack integration test.
#
# Copies the entire monorepo, runs bun install once, then provides
# per-service targets that only set WORKDIR, PORT, and CMD.
#
# Usage in docker-compose:
#   build:
#     context: ..
#     dockerfile: docker-compose/Dockerfile.test
#     target: auth

# Workspace stage — Bun for package management, Node.js for native addon ABI
FROM node:22-alpine AS bun-base

# Bun for workspace-aware package management; build tools for native addons
RUN apk add --no-cache python3 make g++ && npm install -g bun

WORKDIR /app

# Copy root workspace config + lockfile
COPY package.json bun.lock ./

# Copy ALL workspace package.json files for complete resolution
COPY apps/auth/package.json apps/auth/package.json
COPY apps/cli/package.json apps/cli/package.json
COPY apps/envoy/package.json apps/envoy/package.json
COPY apps/gateway/package.json apps/gateway/package.json
COPY apps/node/package.json apps/node/package.json
COPY apps/orchestrator/package.json apps/orchestrator/package.json
COPY packages/authorization/package.json packages/authorization/package.json
COPY packages/config/package.json packages/config/package.json
COPY packages/routing/package.json packages/routing/package.json
COPY packages/sdk/package.json packages/sdk/package.json
COPY packages/service/package.json packages/service/package.json
COPY packages/telemetry/package.json packages/telemetry/package.json
COPY packages/types/package.json packages/types/package.json
COPY packages/pki/package.json packages/pki/package.json
COPY examples/books-api/package.json examples/books-api/package.json
COPY examples/movies-api/package.json examples/movies-api/package.json
COPY examples/orders-api/package.json examples/orders-api/package.json
COPY examples/product-api/package.json examples/product-api/package.json

# Single bun install for the entire monorepo (native addons compile for Node.js ABI)
# Stub husky (devDep, not installed with --omit=dev) so prepare script succeeds
RUN printf '#!/bin/sh\nexit 0\n' > /usr/local/bin/husky && chmod +x /usr/local/bin/husky && bun install --omit=dev

# Copy ALL source code
COPY apps apps
COPY packages packages
COPY examples examples

# Runtime base — Node.js
FROM node:22-alpine AS base

RUN npm install -g tsx

WORKDIR /app
COPY --from=bun-base /app ./

RUN addgroup -S appgroup && adduser -S appuser -G appgroup

# ── Service targets ──────────────────────────────────────────────────

FROM base AS auth
WORKDIR /app/apps/auth
ENV PORT=5000
EXPOSE 5000
USER appuser
CMD ["tsx", "src/server.ts"]

FROM base AS orchestrator
WORKDIR /app/apps/orchestrator
ENV PORT=3000
EXPOSE 3000
USER appuser
CMD ["tsx", "src/server.ts"]

FROM base AS envoy
WORKDIR /app/apps/envoy
ENV PORT=3000
EXPOSE 3000 18000
USER appuser
CMD ["tsx", "src/index.ts"]

FROM base AS gateway
WORKDIR /app/apps/gateway
ENV PORT=4000
EXPOSE 4000
USER appuser
CMD ["tsx", "src/index.ts"]

FROM base AS books-api
WORKDIR /app/examples/books-api
ENV PORT=8080
EXPOSE 8080
USER appuser
CMD ["tsx", "src/index.ts"]
