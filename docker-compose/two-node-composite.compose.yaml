# Two composite nodes for peering UAT.
# Each node runs auth + orchestrator + gateway in a single process.
# This is the primary deployment pattern going forward.
#
# Usage:
#   docker compose -f docker-compose/two-node-composite.compose.yaml up --build
#
# Ports:
#   node-a: http://127.0.0.1:3001  (books subgraph)
#   node-b: http://127.0.0.1:3002  (movies subgraph)

services:
  # --- Node A: composite node + books subgraph ---

  node-a:
    build:
      context: ..
      dockerfile: apps/node/Dockerfile
    ports:
      - '3001:3000'
    environment:
      - PORT=3000
      - CATALYST_NODE_ID=node-a.somebiz.local.io
      - CATALYST_PEERING_ENDPOINT=ws://node-a:3000/orchestrator/rpc
      - CATALYST_DOMAINS=somebiz.local.io
      - CATALYST_PEERING_SECRET=valid-secret
      - CATALYST_AUTH_KEYS_DB=/app/data/keys.db
      - CATALYST_AUTH_TOKENS_DB=/app/data/tokens.db
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://127.0.0.1:3000/health']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      node-a-net:
      peering:
        aliases:
          - node-a

  books-service:
    build:
      context: ..
      dockerfile: examples/books-api/Dockerfile
    environment:
      - PORT=8080
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://127.0.0.1:8080/health']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      node-a-net:

  # --- Node B: composite node + movies subgraph ---

  node-b:
    build:
      context: ..
      dockerfile: apps/node/Dockerfile
    ports:
      - '3002:3000'
    environment:
      - PORT=3000
      - CATALYST_NODE_ID=node-b.somebiz.local.io
      - CATALYST_PEERING_ENDPOINT=ws://node-b:3000/orchestrator/rpc
      - CATALYST_DOMAINS=somebiz.local.io
      - CATALYST_PEERING_SECRET=valid-secret
      - CATALYST_AUTH_KEYS_DB=/app/data/keys.db
      - CATALYST_AUTH_TOKENS_DB=/app/data/tokens.db
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://127.0.0.1:3000/health']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      node-b-net:
      peering:
        aliases:
          - node-b

  movies-service:
    build:
      context: ..
      dockerfile: examples/movies-api/Dockerfile
    environment:
      - PORT=8080
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://127.0.0.1:8080/health']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      node-b-net:

networks:
  node-a-net:
    driver: bridge
  node-b-net:
    driver: bridge
  peering:
    driver: bridge
