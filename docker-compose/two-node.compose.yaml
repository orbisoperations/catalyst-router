services:
  # --- Observability stack ---

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.144.0
    container_name: catalyst-otel-collector-2n
    command: ['--config', '/etc/otel-collector-config.yaml']
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - '4317:4317' # OTLP gRPC
      - '4318:4318' # OTLP HTTP
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:13133']
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Shared auth ---

  auth:
    build:
      context: ..
      dockerfile: apps/auth/Dockerfile
    ports:
      - '4020:4020'
    environment:
      - PORT=4020
      - OTEL_SERVICE_NAME=auth
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:4020/health']
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      otel-collector:
        condition: service_healthy

  # --- Node A: gateway-a + books ---

  gateway-a:
    build:
      context: ..
      dockerfile: apps/gateway/Dockerfile
    ports:
      - '4000:4000'
    environment:
      - PORT=4000
      - OTEL_SERVICE_NAME=gateway-a
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:4000/health']
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      otel-collector:
        condition: service_healthy
      books-service:
        condition: service_healthy

  books-service:
    build:
      context: ..
      dockerfile: examples/books-api/Dockerfile
    ports:
      - '8081:8080'
    environment:
      - PORT=8080
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8080/health']
      interval: 10s
      timeout: 5s
      retries: 5

  node-a:
    build:
      context: ..
      dockerfile: apps/orchestrator/Dockerfile
    ports:
      - '3001:3000'
    environment:
      - PORT=3000
      - CATALYST_NODE_ID=node-a.somebiz.local.io
      - CATALYST_PEERING_ENDPOINT=ws://node-a:3000/rpc
      - CATALYST_DOMAINS=somebiz.local.io
      - CATALYST_PEERING_SECRET=valid-secret
      - CATALYST_GQL_GATEWAY_ENDPOINT=ws://gateway-a:4000/api
      - CATALYST_ENVOY_ENDPOINT=ws://envoy-service:3000/api
      - CATALYST_ENVOY_PORT_RANGE=[10000, [10001, 10050]]
      - OTEL_SERVICE_NAME=orchestrator-node-a
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000/health']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      default:
        aliases:
          - node-a
    depends_on:
      auth:
        condition: service_healthy
      gateway-a:
        condition: service_healthy
      envoy-service:
        condition: service_healthy

  # --- Node B: gateway-b + movies ---

  gateway-b:
    build:
      context: ..
      dockerfile: apps/gateway/Dockerfile
    ports:
      - '4001:4000'
    environment:
      - PORT=4000
      - OTEL_SERVICE_NAME=gateway-b
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:4000/health']
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      otel-collector:
        condition: service_healthy
      movies-service:
        condition: service_healthy

  movies-service:
    build:
      context: ..
      dockerfile: examples/movies-api/Dockerfile
    ports:
      - '8082:8080'
    environment:
      - PORT=8080
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8080/health']
      interval: 10s
      timeout: 5s
      retries: 5

  node-b:
    build:
      context: ..
      dockerfile: apps/orchestrator/Dockerfile
    ports:
      - '3002:3000'
    environment:
      - PORT=3000
      - CATALYST_NODE_ID=node-b.somebiz.local.io
      - CATALYST_PEERING_ENDPOINT=ws://node-b:3000/rpc
      - CATALYST_DOMAINS=somebiz.local.io
      - CATALYST_PEERING_SECRET=valid-secret
      - CATALYST_GQL_GATEWAY_ENDPOINT=ws://gateway-b:4000/api
      - CATALYST_ENVOY_ENDPOINT=ws://envoy-service:3000/api
      - CATALYST_ENVOY_PORT_RANGE=[[10051, 10100]]
      - OTEL_SERVICE_NAME=orchestrator-node-b
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000/health']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      default:
        aliases:
          - node-b
    depends_on:
      auth:
        condition: service_healthy
      gateway-b:
        condition: service_healthy
      envoy-service:
        condition: service_healthy

  # --- Envoy data plane ---

  envoy-service:
    build:
      context: ..
      dockerfile: apps/envoy/Dockerfile
    ports:
      - '3010:3000'
      - '18000:18000'
    environment:
      - PORT=3000
      - CATALYST_NODE_ID=envoy-service
      - CATALYST_ENVOY_XDS_PORT=18000
      - CATALYST_ENVOY_BIND_ADDRESS=0.0.0.0
      - OTEL_SERVICE_NAME=envoy-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000/health']
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      otel-collector:
        condition: service_healthy

  envoy-proxy:
    image: envoyproxy/envoy:v1.32-latest
    ports:
      - '10000:10000'
      - '9901:9901'
    volumes:
      - ./envoy-bootstrap.yaml:/etc/envoy/envoy.yaml:ro
    command: ['-c', '/etc/envoy/envoy.yaml', '--log-level', 'info']
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--no-verbose',
          '--tries=1',
          '--spider',
          'http://localhost:9901/server_info',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      envoy-service:
        condition: service_healthy
