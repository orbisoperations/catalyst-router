# METABEGIN
# X-Env-Layer-Name: catalyst-cloudflared
# X-Env-Layer-Category: net
# X-Env-Layer-Desc: Cloudflare Tunnel for remote SSH access.
#  Requires a tunnel token from the Cloudflare Zero Trust dashboard.
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: ca-certificates,openssh-server
#
# X-Env-VarRequires: IGconf_sys_apt_keydir
# X-Env-VarRequires-Valid: string
#
# X-Env-VarPrefix: cloudflared
#
# X-Env-Var-tunnel_token:
# X-Env-Var-tunnel_token-Desc: Cloudflare Tunnel token (from dashboard or CLI)
# X-Env-Var-tunnel_token-Required: y
# X-Env-Var-tunnel_token-Valid: string
# X-Env-Var-tunnel_token-Set: y
# METAEND
---
mmdebstrap:
  mirrors:
    - deb https://pkg.cloudflare.com/cloudflared bookworm main
  setup-hooks:
    - mkdir -p $1/usr/share/keyrings/
    - curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg -o $1/usr/share/keyrings/cloudflare-main.gpg
    - chmod a+r $1/usr/share/keyrings/cloudflare-main.gpg
    - cp -p $1/usr/share/keyrings/cloudflare-main.gpg $IGconf_sys_apt_keydir
  packages:
    - cloudflared
  customize-hooks:
    # Permanent sources.list entry for the installed system
    - mkdir -p $1/etc/apt/sources.list.d
    - |-
      cat <<- EOF > $1/etc/apt/sources.list.d/cloudflared.list
      deb [arch=arm64 signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared bookworm main
      EOF
    - sed -i '/pkg\.cloudflare\.com/d' $1/etc/apt/sources.list
    # Allow unprivileged ICMP ping sockets (required by cloudflared health checks)
    - |-
      mkdir -p "$1/etc/sysctl.d"
      cat > "$1/etc/sysctl.d/50-cloudflared-ping.conf" <<SYSEOF
      net.ipv4.ping_group_range = 0 2147483647
      SYSEOF
    # Install systemd service with tunnel token
    - |-
      cat > "$1/etc/systemd/system/cloudflared-tunnel.service" <<SVCEOF
      [Unit]
      Description=Cloudflare Tunnel
      After=network-online.target wpa_supplicant@wlan0.service
      Wants=network-online.target

      [Service]
      Type=simple
      ExecStart=/usr/bin/cloudflared tunnel --no-autoupdate run --token $IGconf_cloudflared_tunnel_token
      Restart=on-failure
      RestartSec=5
      AmbientCapabilities=CAP_NET_RAW
      CapabilityBoundingSet=CAP_NET_RAW

      [Install]
      WantedBy=multi-user.target
      SVCEOF
    - $BDEBSTRAP_HOOKS/enable-units "$1" cloudflared-tunnel
