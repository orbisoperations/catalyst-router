# METABEGIN
# X-Env-Layer-Name: catalyst-wifi
# X-Env-Layer-Category: net
# X-Env-Layer-Desc: WiFi via wpa_supplicant + systemd-networkd for headless boot
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: systemd-net-min
#
# X-Env-VarPrefix: wifi
#
# X-Env-Var-ssid:
# X-Env-Var-ssid-Desc: WiFi network SSID
# X-Env-Var-ssid-Required: y
# X-Env-Var-ssid-Valid: string
# X-Env-Var-ssid-Set: y
#
# X-Env-Var-password:
# X-Env-Var-password-Desc: WiFi network password (WPA2-PSK, leave empty for open network)
# X-Env-Var-password-Required: n
# X-Env-Var-password-Valid: string-or-empty
# X-Env-Var-password-Set: y
#
# X-Env-Var-country: US
# X-Env-Var-country-Desc: WiFi regulatory country code (ISO 3166-1 alpha-2)
# X-Env-Var-country-Required: n
# X-Env-Var-country-Valid: regex:^[A-Z]{2}$
# X-Env-Var-country-Set: y
# METAEND
---
mmdebstrap:
  packages:
    - wpasupplicant
    - wireless-tools
    - iw
    - firmware-brcm80211
    - wireless-regdb
    - w3m
  customize-hooks:
    # wpa_supplicant config â€” WPA2-PSK when password is set, open network otherwise
    - |-
      mkdir -p "$1/etc/wpa_supplicant"
      {
        echo "ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev"
        echo "update_config=1"
        echo "country=$IGconf_wifi_country"
        echo ""
        if [ -n "$IGconf_wifi_password" ]; then
          chroot "$1" wpa_passphrase "$IGconf_wifi_ssid" "$IGconf_wifi_password" \
            | grep -v '#psk='
        else
          echo "network={"
          echo "    ssid=\"$IGconf_wifi_ssid\""
          echo "    key_mgmt=NONE"
          echo "}"
        fi
      } > "$1/etc/wpa_supplicant/wpa_supplicant-wlan0.conf"
      chmod 600 "$1/etc/wpa_supplicant/wpa_supplicant-wlan0.conf"
    # systemd-networkd config for wlan0 (DHCP)
    - |-
      cat > "$1/etc/systemd/network/20-wlan0.network" <<NETEOF
      [Match]
      Name=wlan0

      [Network]
      DHCP=yes

      [DHCPv4]
      RouteMetric=600
      NETEOF
    # Ensure WiFi radio is not soft-blocked at boot (rfkill needs real hardware)
    - |-
      cat > "$1/etc/systemd/system/wifi-rfkill-unblock.service" <<'RFKEOF'
      [Unit]
      Description=Unblock WiFi radio
      Before=wpa_supplicant@wlan0.service
      ConditionPathExists=/dev/rfkill

      [Service]
      Type=oneshot
      ExecStart=/usr/sbin/rfkill unblock wifi
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target
      RFKEOF
    - $BDEBSTRAP_HOOKS/enable-units "$1" wifi-rfkill-unblock
    # Ensure resolv.conf points to systemd-resolved stub (safety net)
    - ln -sf /run/systemd/resolve/stub-resolv.conf "$1/etc/resolv.conf"
    # Ensure network-online.target waits for an interface to get an address
    - $BDEBSTRAP_HOOKS/enable-units "$1" systemd-networkd-wait-online
    # Enable wpa_supplicant for wlan0
    - $BDEBSTRAP_HOOKS/enable-units "$1" wpa_supplicant@wlan0
